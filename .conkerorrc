allow_browser_window_close = false;

cwd=get_home_directory();
cwd.append("downloads");

download_buffer_automatic_open_target=OPEN_NEW_BUFFER_BACKGROUND;
hint_digits="0abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNOPQRSTUVWXYZ";
url_remoting_fn = load_url_in_new_buffer;

add_hook("mode_line_hook", mode_line_adder(downloads_status_widget));
add_hook("mode_line_hook", mode_line_adder(buffer_count_widget), true);
remove_hook("mode_line_hook", mode_line_adder(clock_widget));

define_variable("firebug_url",
    "http://getfirebug.com/releases/lite/1.2/firebug-lite-compressed.js");

function firebug (I) {
    var doc = I.buffer.document;
    var script = doc.createElement('script');
    script.setAttribute('type', 'text/javascript');
    script.setAttribute('src', firebug_url);
    script.setAttribute('onload', 'firebug.init();');
    doc.body.appendChild(script);
}
interactive("firebug", "open firebug lite", firebug);
define_key(content_buffer_normal_keymap, "f12", "firebug");

define_key(content_buffer_normal_keymap, "d", "follow-new-buffer-background");
define_key(content_buffer_normal_keymap, "y", "block-images-toggle");
define_key(content_buffer_normal_keymap, "j", "block-scripts-toggle");
define_key(content_buffer_normal_keymap, ".", "content-policy-toggle");

define_webjump("crawl", "http://crawl.chaosforge.org/index.php?title=%s");
define_webjump("github", "http://github.com/search?q=%s&type=Everything");
define_webjump("krautchan", "https://krautchan.net/board/%s");
define_webjump("logs", "http://logs.2pktfkt.de/%s");
define_webjump("reddit","http://www.reddit.com/r/%s");

register_user_stylesheet(
    "data:text/css," + escape(
        "@namespace url(\"http://www.w3.org/1999/xhtml\");" +
        "span.__conkeror_hint { font-size: 18px !important; line-height: 18px !important; }" +
        "body [title] { border-bottom: 2px dotted !important; cursor: help; position: relative; }" +
        "body [title]:hover::after { background-color: white; border: 2px solid !important; color: black; content: attr(title); left: 0; position: absolute; top: 1.5em; z-index: 1; }" +
        "head { display: block !important; text-di}" +
        "link[rel=alternate], link[rel=alternate]::before { display: inline-block !important; margin: 0.375em 0 0 0.375em !important; padding: 0.375em !important; }" +
        "link[rel=alternate]::before { background-color: white; border: 2px solid !important; color: black; content: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAJDSURBVHjajJJNSBRhGMd/887MzrQxRSLbFuYhoUhEKsMo8paHUKFLdBDrUIdunvq4RdClOq8Hb0FBSAVCUhFR1CGD/MrIJYqs1kLUXd382N356plZFOrUO/MMz/vO83+e93n+f+1zF+kQBoOQNLBJg0CTj7z/rvWjGbEOIwKp9O7WkhtQc/wMWrlIkP8Kc1lMS8eyFHpkpo5SgWCCVO7Z5JARhuz1Qg29fh87u6/9VWL1/SPc4Qy6n8c0FehiXin6dcCQaylDMhqGz8ydS2hKkmxNkWxowWnuBLHK6G2C8X6UJkBlxUmNqLYyNbzF74QLDrgFgh9LLE0NsPKxjW1Hz2EdPIubsOFdH2HgbwAlC4S19dT13o+3pS+vcSfvUcq9YnbwA6muW9hNpym/FWBxfh0CZkKGkPBZeJFhcWQAu6EN52QGZ/8prEKW+cdXq0039UiLXhUYzdjebOJQQI30UXp6mZn+Dtam32Afu0iyrgUvN0r+ZQbr8HncSpUVJfwRhBWC0hyGV8CxXBL5SWYf9sYBidYLIG2V87/ifVjTWAX6AlxeK2C0X8e58hOr/Qa2XJ3iLMWxB1h72tHs7bgryzHAN2o2gJorTrLxRHVazd0o4TXiyV2Yjs90uzauGvvppmqcLjwmbZ3V7BO2HOrBnbgrQRqWUgTZ5+Snx4WeKfzCCrmb3axODKNH+vvUyWjqyK4DiKQ0eXSpFsgVvLJQWpH+xSpr4otg/HI0TR/t97cxTUS+QxIMRTLi/9ZYJPI/AgwAoc3W7ZrqR2IAAAAASUVORK5CYII=') ' ' attr(title); margin: 0; }"
    )
);

require("block-content-focus-change.js");

require("content-policy.js");
function block_content(content_type, content_location) {
    if (content_location.host == "localhost") {
        return content_policy_accept;
    } else {
        return content_policy_reject;
    };
};

content_policy_bytype_table.font = block_content;
content_policy_bytype_table.image = block_content;
content_policy_bytype_table.media = block_content;
content_policy_bytype_table.object = block_content;
content_policy_bytype_table.script = block_content;
add_hook("content_policy_hook", content_policy_bytype);

interactive("block-images-toggle",
    "Turn the content-policy block for images off if it is on and on if it is off.",
    function (I) {
        if (content_policy_bytype_table.image == block_content) {
            content_policy_bytype_table.image = function () content_policy_accept;
            I.minibuffer.message("Images are allowed.");
        } else {
            content_policy_bytype_table.image = block_content;
            I.minibuffer.message("Images are blocked.");
        }
    }
);

interactive("block-scripts-toggle",
    "Turn the content-policy for scripts off if it is on, and on if it is off.",
    function (I) {
        if (content_policy_bytype_table.script == block_content) {
            content_policy_bytype_table.script = function () content_policy_accept;
            I.minibuffer.message("Scripts are allowed.");
        } else {
            content_policy_bytype_table.script = block_content;
            I.minibuffer.message("Scripts are blocked.");
        }
    }
);

function content_policy_widget (window) {
    this.class_name = "content-policy-widget";
    text_widget.call(this, window);
    this.add_hook("keypress_hook");
};

content_policy_widget.prototype = {
    constructor: content_policy_widget,
    __proto__: text_widget.prototype,
    update: function () {
        var text = ""
        if (content_policy_bytype_table.image == block_content) {
            text += "noIMG"
        } else {
            text += "IMG"
        };
        text += " ";
        if (content_policy_bytype_table.script == block_content) {
            text += "noJS";
        } else {
            text += "JS";
        };
        this.view.text = text;
    }
};

add_hook("mode_line_hook", mode_line_adder(content_policy_widget));

require("adblockplus.js");

require("favicon");
add_hook("mode_line_hook", mode_line_adder(buffer_icon_widget), true);

session_pref("intl.accept_languages", "de-de, de, en-us, en");

set_protocol_handler("mailto", find_file_in_path("claws-mail"));
